&emsp;
# 1 旋转矩阵

## 1.1 点和向量，坐标系

我们日常生活的空间是三维的，因此我们生来就习惯于三维空间的运动。三维空间由三个轴组成，所以一个空间点的位置可以由三个坐标指定。不过，我们现在要考虑刚体，它不光有位置，还有自身的姿态。

相机也可以看成三维空间的刚体，于是位置是指相机在空间中的哪个地方，而姿态则是指相机的朝向。结合起来，我们可以说，“相机正处于空间 $(0, 0, 0)$ 点处，朝向正前方” 这样的话。但是这种自然语言很繁琐，我们更喜欢用数学语言来描述它。

我们从最基本的开始讲起：点和向量。

&emsp;
>向量
- 向量是线性空间中的一个元素，可以把它想象成从 `原点` 指向某处的一个箭头。

&emsp;

需要提醒读者的是，请不要把 `向量` 与 `向量的坐标` 两个概念混淆。



&emsp;
>向量的坐标
- 只有当我们指定这个三维空间中的某个坐标系时，才可以谈论该向量在此坐标系下的坐标，也就是找到若干个实数对应这个向量。

    例如，三维空间中的 `某个向量` 的坐标可以用 $\mathbb{R}^3$ 当中的三个数来描述。`某个点的坐标` 也可以用 $\mathbb{R}^3$ 来描述。

    怎么描述的呢？如果我们确定一个坐标系，也就是一个线性空间的基 $(\pmb{e}_1, \pmb{e}_2, \pmb{e}_3)$，那就可以谈论向量 $\pmb{a}$ 在这组基下的坐标了：

    $$\pmb{a} = [\pmb{e}_1, \pmb{e}_2, \pmb{e}_3]
    \begin{bmatrix}a_1 \\ a_2 \\ a_3\end{bmatrix}   = a_1\pmb{e}_1 + a_2\pmb{e}_3 + a_3\pmb{e}_3$$

    所以这个坐标的具体取值，一个是和向量本身有关，第二也和坐标系的选取有关。坐标系通常由三个正交的坐标轴组成（尽管也可以有非正交的，但实际中很少见）。例如，我们给定 $x$ 和 $y$ 轴时，$z$ 就可以通过右手（或左手）法则由 $x × y$ 定义出来。根据定义方式的不同，坐标系又分为左手系和右手系。左手系的第三个轴与右手系相反。就经验来讲，人们更习惯使用右手系，尽管也有一部分程序库仍使用左手系。

&emsp;
>向量的内积
- 对于 $\pmb{a}, \pmb{b} ∈ \mathbb{R}^3$，内积可以写成：

$$\pmb{a} · \pmb{b} = \pmb{a}^T \pmb{b} = \sum\limits_{i=1}^3 a_ib_i = |\pmb{a}| |\pmb{b}| cos⟨\pmb{a}, \pmb{b}⟩$$

&emsp;
>向量的外积

$$\pmb{a} \times \pmb{b} = 
\begin{vmatrix} \pmb{i} & \pmb{j} &\pmb{k} \\
\pmb{a}_1 & \pmb{a}_2 & \pmb{a}_3 \\
\pmb{b}_1 & \pmb{b}_2 & \pmb{b}_3 \\
\end{vmatrix} = 
(\pmb{a}_2 \pmb{b}_3)\pmb{i} + (\pmb{a}_3 \pmb{b}_1)\pmb{j} + (\pmb{a}_1 \pmb{b}_2)\pmb{k} $$

$$\qquad\qquad\qquad\qquad\quad\ - (\pmb{a}_3 \pmb{b}_2)\pmb{i} - (\pmb{a}_1 \pmb{b}_3)\pmb{j}- (\pmb{a}_2 \pmb{b}_1)\pmb{k}$$

$$\qquad\qquad\qquad\quad\ \ =[\pmb{i}，\pmb{j}，\pmb{k}]\begin{bmatrix}
\pmb{a}_2 \pmb{b}_3 - \pmb{a}_3 \pmb{b}_2 \\ 
\pmb{a}_3 \pmb{b}_1 - \pmb{a}_1 \pmb{b}_3 \\ 
\pmb{a}_1 \pmb{b}_2 - \pmb{a}_2 \pmb{b}_1 \\ 
\end{bmatrix} = \begin{bmatrix}
0 & -\pmb{a}_3 & \pmb{a}_2 \\
\pmb{a}_3 & 0 & -\pmb{a}_1 \\
-\pmb{a}_2 & \pmb{a}_1 & 0\end{bmatrix} \pmb{b} \triangleq \pmb{a}^{\wedge}\pmb{b}$$

- 外积的方向垂直于这两个向量
- $\pmb{a} × \pmb{b} = -\pmb{b} × \pmb{a}$
- 大小为 $|\pmb{a} \times \pmb{b}| = |a|\ |b|\ sin \hat{(\pmb{a}，\pmb{b})}$，是两个向量张成的四边形的有向面积

&emsp;
>反对称矩阵符号
- 对于外积，我们引入了 `∧` 符号，把 $\pmb{a}$ 写成一个矩阵。事实上是一个`反对称矩阵（Skew-symmetric）`，你可以将 `∧` 记成一个反对称符号。

    这样就把外积 $\pmb{a} × \pmb{b}$，写成了 `反对称矩阵`$\pmb{a}^∧$ 与 `向量`$\pmb{b}$ 的乘法：
    $$\pmb{a} × \pmb{b} = \pmb{a}^∧\pmb{b}$$

    把它变成了`线性运算`。这个符号将在后文经常用到，请记住它。外积只对三维向量存在定义，我们还能用外积表示向量的旋转。

&emsp;
>外积表示旋转

<div align="center">
    <image src="./imgs/3.1-1.png" width = 500>
</div>
&emsp;

考虑两个不平行的向量 $\pmb{a}$, $\pmb{b}$，我们要描述从 $\pmb{a}$ 到 $\pmb{b}$ 之间是如何旋转的，如图 3-1 所示。我们可以用一个向量来描述三维空间中两个向量的旋转关系。

在右手法则下，我们用右手的四个指头从 $\pmb{a}$ 转向 $\pmb{b}$，其大拇指朝向就是旋转向量的方向，事实上也是 $\pmb{a} × \pmb{b}$ 的方向。它的大小则由 $\pmb{a}$ 和 $\pmb{b}$ 的夹角决定。通过这种方式，我们构造了从 $\pmb{a}$ 到 $\pmb{b}$ 的一个旋转向量。这个向量同样位于三维空间中，在此坐标系下，可以用三个实数来描述它。

&emsp;
## 1.2 坐标系之间的欧式变换
与向量间的旋转类似，我们同样可以描述两个坐标系之间的旋转关系，再加上平移，统称为`坐标系之间的变换关系`。

<div align="center">
    <image src="./imgs/3.1-2.png" width = 500>
</div>
&emsp;

>世界坐标系（惯性坐标系）
- 在机器人的运动过程中，常见的做法是设定一个惯性坐标系（或者叫世界坐标系），可以认为它是 `固定不动的（相对的）`，例如图 3-2 中的 $x_W , y_W , z_W$ 定义的坐标系。向量 $\pmb{p} = \overrightarrow{O_wP}$

>世界坐标系的选取
- 在实践中，世界坐标系的选取可分为两种情况，单目相机与双目相机。

    - `单目相机`：在单目相机中，我们通常选择拍摄第一张图像时的相机坐标系作为世界坐标系，即以拍摄第一张图像时相机的光心（小孔）作为原点，X轴为水平方向，Y轴为竖直方向，Z轴指向拍摄第一张图像时相机所观察的方向。选定后世界坐标系便不再发生变化，即不变且唯一。

    - `双目相机`：在双目相机(A,B)中，与单目相机大同小异，我们可选取其中一个相机A拍摄第一张图像时的相机坐标系为世界坐标系，即以相机A拍摄第一张图像时相机的光心（小孔）作为原点，X轴为水平方向，Y轴为竖直方向，Z轴指向拍摄第一张图像时相机A所观察的方向。

>移动坐标系（相机坐标系）
- 同时，相机或机器人则是一个移动坐标系，例如 $x_C , y_C , z_C$ 定义的坐标系。向量 $\pmb{p} = \overrightarrow{O_cP}$

>转换矩阵$T$
- 我们会问：相机视野中某个向量 $\pmb{p}$，它的坐标为 $\pmb{p}_c$，而从世界坐标系下看，它的坐标 $\pmb{p}_w$。这两个坐标之间是如何转换的呢？这时，就需要先得到该点针对机器人坐标系坐标值，再根据机器人位姿转换到世界坐标系中，这个转换关系由一个矩阵 $T$ 来描述，如图 3-2 所示。

&emsp;
>欧式变换
- 相机运动是一个刚体运动，它保证了同一个向量在各个坐标系下的长度和夹角都不会发生变化。这种变换称为 `欧氏变换`。

    想象你把手机抛到空中，在它落地摔碎之前，只可能有`空间位置`和`姿态`的不同，而它自己的`长度`、`各个面的角度等性质`不会有任何变化。这样一个欧氏变换由两部分组成：
    - 一个旋转
    - 一个平移

&emsp;
### （1）坐标系的旋转

首先来考虑旋转。我们设某个单位正交基 $(\pmb{e}_1，\pmb{e}_2，\pmb{e}_3)$ 经过一次旋转，变成了 $(\pmb{e'}_1，\pmb{e'}_2，\pmb{e'}_3)$。

那么，对于同一个向量 $\pmb{a}$（注意该向量并没有随着坐标系的旋转而发生运动），它在两个坐标系下的坐标为 $[\pmb{a}_1，\pmb{a}_2，\pmb{a}_3]^T$ 和 $[\pmb{a'}_1，\pmb{a'}_2，\pmb{a'}_3]^T$ 根据坐标的定义，有：
$$\begin{bmatrix}\pmb{e}_1，\pmb{e}_2，\pmb{e}_3\end{bmatrix}
\begin{bmatrix}\pmb{a}_1 \\ \pmb{a}_2 \\ \pmb{a}_3\end{bmatrix} = 
\begin{bmatrix}\pmb{e'}_1，\pmb{e'}_2，\pmb{e'}_3\end{bmatrix}
\begin{bmatrix}\pmb{a'}_1 \\ \pmb{a'}_2 \\ \pmb{a'}_3\end{bmatrix}$$

我们对上面等式左右同时左乘 
$\begin{bmatrix}\pmb{e}_1^T \\\\ \pmb{e}_2^T \\\\ \pmb{e}_3^T\end{bmatrix}$

那么左边的系数变成了单位矩阵，所以：
$$\begin{bmatrix}\pmb{a}_1 \\ \\ \pmb{a}_2 \\ \\\pmb{a}_3\end{bmatrix} = 
\begin{bmatrix}\pmb{e}_1^T\pmb{e'}_1 & \pmb{e}_1^T\pmb{e'}_2  & \pmb{e}_1^T\pmb{e'}_3 \\ \\
\pmb{e}_2^T\pmb{e'}_1 & \pmb{e}_2^T\pmb{e'}_2  & \pmb{e}_2^T\pmb{e'}_3 \\ \\
\pmb{e}_3^T\pmb{e'}_1 & \pmb{e}_3^T\pmb{e'}_2  & \pmb{e}_3^T\pmb{e'}_3 \end{bmatrix}
\begin{bmatrix}\pmb{a'}_1 \\ \\ \pmb{a'}_2 \\ \\\pmb{a'}_3\end{bmatrix} \triangleq \pmb{Ra'}$$

&emsp;
>旋转矩阵

- 我们把中间的阵拿出来，定义成一个矩阵 $\pmb{R}$。这个矩阵由两组基之间的内积组成
    $$\pmb{R}=\begin{bmatrix}\pmb{e}_1^T \\ \\\pmb{e}_2^T \\ \\\pmb{e}_3^T\end{bmatrix}
    \begin{bmatrix}\pmb{e'}_1，\pmb{e'}_2，\pmb{e'}_3\end{bmatrix}$$
    刻画了旋转前后同一个向量的坐标变换关系。只要旋转是一样的，那么这个矩阵也是一样的。可以说，矩阵 R 描述了旋转本身。因此它又称为 `旋转矩阵`。

&emsp;
>旋转矩阵的性质
- 它是一个行列式为 1 的正交矩阵。反之，行列式为 1 的正交矩阵也是一个旋转矩阵。所以，我们可以把旋转矩阵的集合定义如下：
    $$SO(n) = \{ \pmb{R} \in \mathbb{R}^{n\times n} | \pmb{R}\pmb{R}^T = \pmb{I}，det(\pmb{R})=1\}$$
    - $SO(n)$ 是 `特殊正交群（Special Orthogonal Group）`的意思。我们把解释“群”的内容留到下一讲
    - 这个集合由 `n维空间` 的旋转矩阵组成，特别的，$SO(3)$ 就是 `三维空间` 的旋转了
    - 通过旋转矩阵，我们可以直接谈论两个坐标系之间的旋转变换，而不用再从基开始谈起了。换句话说，旋转矩阵可以描述相机的旋转。
    - 由于旋转矩阵为正交阵，它的逆（即转置）描述了一个相反的旋转。按照上面的定义方式，有：
    $$\pmb{a}' = \pmb{R}^{-1}\pmb{a} = \pmb{R}^T\pmb{a}$$
    - 显然 $\pmb{R}^T$ 刻画了一个相反的旋转。



&emsp;
### （2）坐标系的平移
在欧氏变换中，除了旋转之外还有一个平移。考虑世界坐标系中的向量 $\pmb{a}$，经过一次旋转（用 $\pmb{R}$ 描述）和一次平移 $\pmb{t}$ 后，得到了 $\pmb{a}'$，那么把旋转和平移合到一起，有：
    $$\pmb{a}' = \pmb{R}\pmb{a} + \pmb{t}$$

其中，$\pmb{t}$ 称为`平移向量`。相比于旋转，平移部分只需把这个平移量加到旋转之后的坐标上，显得非常简洁。通过上式，我们用一个旋转矩阵 $\pmb{R}$ 和一个平移向量 $\pmb{t}$ 完整地描述了一个欧氏空间的坐标变换关系。


&emsp;
## 1.3 变换矩阵与齐次坐标


>齐次坐标
- 齐次坐标：https://www.bilibili.com/video/BV1LS4y1b7xZ?spm_id_from=333.337.search-card.all.click&vd_source=ead820d10887c21595d014f264bcbb35

    稍微来说一下齐次坐标。它是射影几何里的概念。通过添加最后一维，我们用四个实数描述了一个三维向量，这显然多了一个自由度，但允许我们把变换写成线性的形式。在齐次坐标中，某个点 $x$ 的每个分量同乘一个非零常数 $k$ 后，仍然表示的是同一个点。因此，一个点的具体坐标值不是唯一的。如 $[1, 1, 1, 1]^T$ 和 $[2, 2, 2, 2]^T$ 是同一个点。但当最后一项不为零时，我们总可以把所有坐标除以最后一项，强制最后一项为 $1$，从而得到一个点唯一的坐标表示（也就是转换成非齐次坐标）：

    $$\tilde{x} = [x, y, z, w]^T = [x/w, y/w, z/w, 1]^T$$
    这时，忽略掉最后一项，这个点的坐标和欧氏空间就是一样的。依靠齐次坐标和变换矩阵，两次变换的累加就可以有很好的形式：
    $$\tilde{b} = \pmb{T}_1\tilde{a}， \tilde{c} = \pmb{T}_2\tilde{b} \quad \Rightarrow \quad \tilde{c} = \pmb{T}_2\pmb{T}_1 \tilde{a}$$

    但是区分齐次和非齐次坐标的符号令我们厌烦。在不引起歧义的情况下，以后我们就直接把它写成 $\pmb{b} = \pmb{T} \pmb{a}$ 的样子，默认其中是齐次坐标了。


$\pmb{a}' = \pmb{R}\pmb{a} + \pmb{t}$ 完整地表达了欧氏空间的旋转与平移，不过还存在一个小问题：这里的变换关系不是一个线性关系。假设 $\pmb{a}$ 进行了两次变换，变换为 $\pmb{c}$：$\pmb{R}_1$, $\pmb{t}_1$ 和 $\pmb{R}_2$, $\pmb{t}_2$ ：

$$\pmb{b} = \pmb{R}_1\pmb{a} + \pmb{t}_1，\pmb{c} = \pmb{R}_2\pmb{b} + \pmb{t}_2$$

这样的形式在变换多次之后会过于复杂。因此，我们要引入`齐次坐标` 和 `变换矩阵` 重写 $\pmb{a}' = \pmb{R}\pmb{a} + \pmb{t}$ 这个式子（改成矩阵乘法的形式）：

$$\begin{bmatrix} \pmb{a'} \\ \\ 1\end{bmatrix} = 
\begin{bmatrix} \pmb{R} & \pmb{t} \\ \\ 
0^T & 1\end{bmatrix} \begin{bmatrix} \pmb{a} \\ \\ 1\end{bmatrix}\triangleq
\pmb{T}\begin{bmatrix} \pmb{a} \\\\ 1\end{bmatrix} \quad (3.9)$$

这是一个数学技巧：我们把一个三维向量的末尾添加 $1$，变成了四维向量，称为`齐次坐标`。对于这个四维向量，我们可以把旋转和平移写在一个矩阵里面，使得整个关系变成了线性关系。该式中，矩阵 $\pmb{T}$ 称为 `变换矩阵（Transform Matrix）`。

我们暂时用 $\pmb{a}˜$ 表示 $\pmb{a}$ 的齐次坐标。

>变换矩阵 $T$ 的其它含义
- 以 $T_{CW}$ 为例
    $$[\ \pmb{R}\qquad \pmb{t}\ ] = [\pmb{X}\ \pmb{Y}\ \pmb{Z}\quad t ] = \begin{bmatrix}
    x_1 & y_1 & z_1 & t_1 \\
    x_2 & y_2 & z_2 & t_2 \\
    x_3 & y_3 & z_3 & t_3 \\
    \end{bmatrix}$$
    - $\pmb{X}\ \pmb{Y}\ \pmb{Z}$: 分别代表相机坐标系 $C$ 的 x, y, z 轴在世界坐标系 $W$ 下对应的方向
    - $\pmb{t}$: 相机原点在世界坐标系的对应位置


&emsp;
>$SE(3)$ 特殊欧式群
- 关于变换矩阵 $\pmb{T}$，它具有比较特别的结构：
    - 左上角为旋转矩阵
    - 右侧为平移向量
    - 左下角为 $\pmb{0}$ 向量
    - 右下角为 $1$

    这种矩阵又称为 `特殊欧氏群（Special Euclidean Group）`：
    $$SE(3) = \begin{Bmatrix}\pmb{T}=\begin{bmatrix}
    \pmb{R} & \pmb{t} \\ \pmb{0}^T & 1\end{bmatrix} \in \mathbb{R}^{4\times 4}|\pmb{R} \in SO(3)，\pmb{t} \in \mathbb{R}^3\end{Bmatrix}$$

    与 $SO(3)$ 一样，求解该矩阵的逆表示一个反向的变换：
    $$\pmb{T}^{-1} = \begin{bmatrix}
    \pmb{R}^T & -\pmb{R}^T\pmb{t} \\ 0^T & 1
    \end{bmatrix}$$

最后，为了保持符号的简洁，在不引起歧义的情况下，我们以后不区别齐次坐标与普通的坐标的符号，默认我们使用的是符合运算法则的那一种。

例如
- 写 $\pmb{Ta}$ 时，使用的是齐次坐标（不然没法计算）
- 写 $\pmb{Ra}$ 时，使用的是非齐次坐标。
- 如果写在一个等式中，我们就假设齐次坐标到普通坐标的转换，是已经做好了的——因为齐次坐标和非齐次坐标之间的转换事实上非常容易。


回顾一下我们介绍的内容：
- 首先，我们说了向量和它的坐标表示，并介绍了向量间的运算
- 然后，坐标系之间的运动由 `欧氏变换` 描述，它由 `平移` 和 `旋转` 组成
    - 旋转可以由旋转矩阵` SO(3)（特殊正交群）` 描述
    - 平移直接由一个 $\mathbb{R}^3$ 向量描述
- 最后，如果将平移和旋转放在一个矩阵中，就形成了变换矩阵 `SE(3)（特殊欧式群）`。