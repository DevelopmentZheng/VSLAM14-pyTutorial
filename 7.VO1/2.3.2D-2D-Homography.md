&emsp;
## 3.3 单应矩阵
除了基本矩阵和本质矩阵，我们还有一种称为 `单应矩阵（Homography）H` 的东西，它描述了 `两个平面之间的映射关系`。若场景中的特征点都落在同一平面上（比如墙，地面等），则可以通过单应性来进行运动估计。

这种情况在 `无人机` 携带的俯视相机，或 `扫地机` 携带的顶视相机中比较常见。由于之前没提到过单应，我们稍微介绍一下。

>单应矩阵
- 单应矩阵通常描述处于共同平面上的一些点，在两张图像之间的变换关系。考虑在图
像 $I_1$ 和 $I_2$ 有一对匹配好的特征点 $p_1$ 和 $p_2$。这些特征点落在某平面上。设这个平面满足方程：
    $$\pmb{n}^T\pmb{P} + d = 0$$
    稍加整理得：
    $$-\frac{\pmb{n}^T \pmb{P}}{d} = 1$$
    然后，回顾式 $(7.1)$
    $$s_1\pmb{p}_1 = \pmb{KP}，s_2\pmb{p}_2 = \pmb{K}(\pmb{RP} + \pmb{t}) \quad (7.1)$$
    得：
    $$\pmb{p}_2 = \pmb{K}(\pmb{RP} + \pmb{t})$$
    $$\qquad\qquad\qquad= \pmb{K}\Big(\pmb{RP} + \pmb{t}\cdot (-\frac{\pmb{n}^T \pmb{P}}{d}) \Big)$$
    $$\qquad\quad= \pmb{K}\Big(\pmb{R}  - \frac{\pmb{tn}^T}{d} \Big)\pmb{P}$$
    $$\qquad\qquad\quad = \pmb{K}\Big(\pmb{R}  - \frac{\pmb{tn}^T}{d} \Big)\pmb{K}^{-1}\pmb{p}_1$$
    于是，我们得到了一个直接描述图像坐标 $\pmb{p}_1$ 和 $\pmb{p}_2$ 之间的变换，把中间这部分记为 $\pmb{H}$，于是
    $$\pmb{p}_2 = \pmb{H}\pmb{p}_1，\pmb{H}= \pmb{R}  - \frac{\pmb{tn}^T}{d}$$

    >
    ```c++
    //-- 计算单应矩阵
    Mat homography_matrix;
    homography_matrix = findHomography ( points1, points2, RANSAC, 3 );
    cout<<"homography_matrix is "<<endl<<homography_matrix<<endl;
    ```

&emsp;
>单应矩阵求解
- 它的定义与旋转、平移以及平面的参数有关。与基础矩阵 $\pmb{F}$ 类似，单应矩阵 $\pmb{H}$ 也是一个 $3 × 3$ 的矩阵，求解时的思路也和 $\pmb{F}$ 类似，同样地可以先根据匹配点计算 $\pmb{H}$，然后将它分解以计算旋转和平移。把上式展开，得：

    $$\begin{pmatrix}
    u_2 \\ v_2 \\ 1
    \end{pmatrix} =
    \begin{pmatrix}
    h_1 & h_2 & h_3 \\
    h_4 & h_5 & h_6 \\
    h_7 & h_8 & h_9 
    \end{pmatrix}
    \begin{pmatrix}
    u_1 \\ v_1 \\ 1
    \end{pmatrix}$$

    请注意这里的等号是在非零因子下成立的。我们在实际处理中，通常乘以一个非零因子使得 $h_9 = 1$（在它取非零值时）。然后根据第三行，去掉这个非零因子，于是有：

    $$u_2 = \frac{h_1u_1 + h_2v_1 + h_3}
    {h_7u_1 + h_8v_1 + h_9}$$
    $$u_2 = \frac{h_4u_1 + h_5v_1 + h_6}
    {h_7u_1 + h_8v_1 + h_9}$$

    整理得：

    $$h_1u_1 + h_2v_1 + h_3 + h_7u_1u_2 + h_8v_1u_2 = u_2$$
    $$h_4u_1 + h_5v_1 + h_6 + h_7u_1v_2 + h_8v_1v_2 = v_2$$

    这样一组匹配点对就可以构造出两项约束（事实上有三个约束，但是因为线性相关，只取前两个），于是自由度为 $8$ 的单应矩阵可以通过 $4$ 对匹配特征点算出（注意：这些特征点不能有三点共线的情况），即求解以下的线性方程组（当 $h_9 = 0$ 时，右侧为零）：
    <div align="center">
        <image src="./imgs/7.3.3-1.png" width = 600>
    </div>
    &emsp;

    这种做法把 $\pmb{H}$ 矩阵看成了向量，通过解该向量的线性方程来恢复 $\pmb{H}$，又称 `直接线性变换法（Direct Linear Transform）`。
    
    
>单应矩阵分解
- 与本质矩阵相似，求出单应矩阵以后需要对其进行分解，才可以得到相应的旋转矩阵 $\pmb{R}$ 和平移向量 $\pmb{t}$。

    分解的方法包括
    - 数值法 [42][43] 

    - 解析法 [44]

    与本质矩阵的分解类似，单应矩阵的分解同样会返回 `四组旋转矩阵` 与 `平移向量`，并且同时可以计算出它们分别对应的场景点所在平面的法向量。
    
    如果已知成像的地图点的深度全为正值（即在相机前方），则又可以排除两组解。最后仅剩两组解，这时需要通过更多的先验信息进行判断。通常我们可以通过假设已知场景平面的法向量来解决，如场景平面与相机平面平行，那么法向量 $\pmb{n}$ 的理论值为 $\pmb{1}^T$。

    单应性在 SLAM 中具重要意义。当特征点共面，或者相机发生纯旋转的时候，基础矩阵的自由度下降，这就出现了所谓的 `退化（degenerate）`。现实中的数据总包含一些噪声，这时候如果我们继续使用八点法求解基础矩阵，基础矩阵多余出来的自由度将会主要由噪声决定。
    
    为了能够避免退化现象造成的影响，通常我们会同时估计基础矩阵 $\pmb{F}$ 和单应矩阵 $\pmb{H}$，选择重投影误差比较小的那个作为最终的运动估计矩阵。
