&emsp;
# 7.7.3 Bundle Adjustment

<div align="center">
    <image src="./imgs/7.7.3-1.png" width = 400>
</div>
&emsp;

除了使用线性方法之外，我们可以把 $PnP$ 问题构建成一个定义于李代数上的非线性最小二乘问题。这将用到本书第四章和第五章的知识。
- 线性方法，往往是先求`相机位姿，再求空间点位置`
- 非线性优化则是把它们都看成优化变量，放在一起优化。这是一种非常通用的求解方式，我们可以用它对 $PnP$ 或 $ICP$ 给出的结果进行优化。


在 $PnP$ 中，这个 Bundle Adjustment 问题，是一个最小化重投影误差（Reprojection error）的问题。我们在本节给出此问题在两个视图下的基本形式，然后在第十讲讨论较大规模的 BA问题。

考虑 $n$ 个三维空间点 $P$ 和它们的投影 $p$，我们希望计算相机的位姿 $\pmb{R}, \pmb{t}$，它的李代数表示为 $\pmb{ξ}$。假设某空间点坐标为 $\pmb{P}_i = [X_i, Y_i, Z_i]T$，其投影的像素坐标为 $\pmb{u}_i = [u_i, v_i]^T$。

根据第五章的内容，像素位置与空间点位置的关系如下：

$$s_i\begin{bmatrix} u_i \\ v_i \\ 1\end{bmatrix} = 
\pmb{K}exp(\pmb{\xi})\begin{bmatrix}
X_i \\ Y_i \\ Z_i \\ 1
\end{bmatrix}$$

除了用 $ξ$ 为李代数表示的相机姿态之外，别的都和前面的定义保持一致。写成矩阵形式就是：

$$s_i\pmb{u}_i = \pmb{K}exp(\pmb{\xi})\pmb{P}_i$$

请读者脑补中间隐含着的齐次坐标到非齐次的转换，否则按矩阵的乘法来说，维度是不对的。现在，由于相机位姿未知以及观测点的噪声，该等式存在一个误差。因此，我们把误差求和，构建最小二乘问题，然后寻找最好的相机位姿，使它最小化：

$$\xi^* = arg \min_{\xi}\frac{1}{2}\sum\limits^n_{i=1}
||\pmb{u}_i - \frac{1}{s_i}\pmb{K}exp(\xi^{\wedge})\pmb{P}_i||^2_2$$

该问题的误差项，是将像素坐标（观测到的投影位置）与 $3D$ 点按照当前估计的位姿进行投影得到的位置相比较得到的误差，所以称之为重投影误差。

使用齐次坐标时，这个误差有 $3$ 维。不过，由于 $\pmb{u}$ 最后一维为 $1$，该维度的误差一直为零，因而我们更多时候使用非齐次坐标，于是误差就只有 $2$ 维了。如图 7-12 所示，我们通过特征匹配，知道了 $p_1$ 和 $p_2$ 是同一个空间点 $P$ 的投影，但是我们不知道相机的位姿。

在初始值中，$P$ 的投影 $\hat{p}_2$与实际的 $p_2$ 之间有一定的距离。于是我们调整相机的位姿，使得这个距离变小。不过，由于这个调整需要考虑很多个点，所以最后每个点的误差通常都不会精确为零。

最小二乘优化问题已经在第六讲介绍过了。使用李代数，可以构建无约束的优化问题，很方便地通过 $G-N， L-M$ 等优化算法进行求解。不过，在使用 $G-N$ 和 $L-M$ 之前，我们需要知道每个误差项关于优化变量的导数，也就是线性化：

$$\pmb{e}(\pmb{x} +  ∆\pmb{x}) \approx \pmb{e}(\pmb{x}) + \pmb{J}∆\pmb{x}$$

这里的 $\pmb{J}$ 的形式是值得讨论的，甚至可以说是关键所在。我们固然可以使用数值导数，但如果能够推导解析形式时，我们会优先考虑解析导数。现在，当 
- $\pmb{e}$ 为像素坐标误差（$2$ 维）
- $\pmb{x}$ 为相机位姿（$6$ 维）时
- $\pmb{J}$ 将是一个 $2 × 6$ 的矩阵

&emsp;
>$\pmb{J}$ 的形式推导

回忆李代数的内容，我们介绍了如何使用扰动模型来求李代数的导数。首先，记变换
到相机坐标系下的空间点坐标为 $\pmb{P}'$，并且把它前三维取出来：

$$\pmb{P}' = (exp(\xi^{\wedge})\pmb{P})_{1:3} = [X'，Y'，Z']^T$$

那么，相机投影模型对于 $\pmb{P}'$，并且把它前三维取出来：
$$\pmb{P}' = (exp(\xi^∧)\pmb{P})_{1:3} = [X'，Y'，Z']^T$$

那么，相机投影模型相对于 $P'$ 则为：

$$s\pmb{u} = \pmb{K}\pmb{P}'$$

展开之：
$$\begin{bmatrix}su \\ sv \\ s\end{bmatrix} = 
\begin{bmatrix} f_x & 0 & c_x \\
0 & f_y & c_y \\
0 & 0 & 1\end{bmatrix}\begin{bmatrix}
X'\\ Y'\\ Z'\end{bmatrix}$$

利用第 $3$ 行消去 $s$（实际上就是 $\pmb{P}'$ 的距离），得：

$$u = f_x\frac{X'}{Z'} + c_x，v = f_y\frac{X'}{Z'} + c_y$$

这与之前讲的相机模型是一致的。当我们求误差时，可以把这里的 $u, v$ 与实际的测量值比较，求差。在定义了中间变量后，我们对 $\pmb{ξ}^∧$ 左乘扰动量 $δ\pmb{ξ}$，然后考虑 $\pmb{e}$ 的变化关于扰动量的导数。利用链式法则，可以列写如下：

$$\frac{\partial\pmb{e}}{\partial δ\pmb{ξ}} = 
\lim_{δ\pmb{ξ} \rightarrow 0} \frac{e(δ\pmb{ξ} \oplus\pmb{ξ})}{δ\pmb{ξ}} = 
\frac{\partial\pmb{e}}{\partial \pmb{P}'}
\frac{\partial \pmb{P}'}{\partial δ\pmb{ξ}}$$

这里的 $⊕$ 指李代数上的左乘扰动。第一项是误差关于投影点的导数，在式$（7.40）$已经列出了变量之间的关系，易得：

$$\frac{\partial\pmb{e}}{\partial \pmb{P}'} = 
-\begin{bmatrix}
\frac{∂u}{∂X'} & \frac{∂u}{∂Y'} & \frac{∂u}{∂Z'} \\\\
\frac{∂v}{∂X'} & \frac{∂v}{∂Y'} & \frac{∂v}{∂Z'} 
\end{bmatrix} = 
-\begin{bmatrix}
\frac{f_x}{Z'} & 0 & -\frac{f_xX'}{Z'^2} \\\\
0 & \frac{f_y}{Z'} & -\frac{f_yY'}{Z'^2} 
\end{bmatrix}$$

而第二项为变换后的点关于李代数的导数，根据在4.3.5中的推导，得：

$$\frac{∂(\pmb{TP})}{∂δξ} = (\pmb{TP})^{\odot} = 
\begin{bmatrix} \pmb{I} & -\pmb{P}'^∧ \\
\pmb{0}^T & \pmb{0}^T\end{bmatrix}$$

而在 $\pmb{P}'$ 的定义中，我们取出了前三维，于是得：
$$\frac{∂\pmb{P}'}{∂δξ} = 
\begin{bmatrix} \pmb{I}，-\pmb{P}'^∧\end{bmatrix}$$

将这两项相乘，就得到了 $2 × 6$ 的雅可比矩阵：
$$\frac{∂\pmb{e}}{∂δξ} = -
\begin{bmatrix}
\frac{f_x}{Z'}      & 0 & -\frac{f_xX'}{Z'^2} & 
-\frac{f_xX'Y'}{Z'^2} & f_x+\frac{f_xX^2}{Z'^2} & -\frac{f_xY'}{Z'} \\\\

0 & \frac{f_y}{Z'}  & -\frac{f_yY'}{Z'^2} & 
-f_y-\frac{f_yY^2}{Z'^2} & -\frac{f_yX'Y'}{Z'^2}  & -\frac{f_yX'}{Z'} 
\end{bmatrix}$$

这个雅可比矩阵描述了重投影误差关于相机位姿李代数的一阶变化关系。我们保留了前面的负号，因为这是由于误差是由观测值减预测值定义的。它当然也可反过来，定义成“预测减观测”的形式。在那种情况下，只要去掉前面的负号即可。此外，如果 $\mathfrak{se}(3)$ 的定义方式是旋转在前，平移在后时，只要把这个矩阵的前三列与后三列对调即可。

另一方面，除了优化位姿，我们还希望优化特征点的空间位置。因此，需要讨论 $\pmb{e}$ 关于空间点 $\pmb{P}$ 的导数。所幸这个导数矩阵相对来说容易一些。仍利用链式法则，有：

$$\frac{∂\pmb{e}}{∂\pmb{P}} = \frac{∂\pmb{e}}{∂\pmb{P}'}\frac{∂\pmb{P}'}{∂\pmb{P}}$$

第一项已在前面推导了，第二项，按照定义

$$\pmb{P}' = exp(ξ^∧)\pmb{P} = \pmb{R}\pmb{P} + \pmb{t}$$

我们发现 $\pmb{P}'$ 对 $\pmb{P}$ 求导后只剩下 $\pmb{R}$。于是

$$\frac{∂\pmb{e}}{∂\pmb{P}} = -
\begin{bmatrix}
\frac{f_x}{Z'} & 0 & -\frac{f_xX'}{Z'^2} \\\\
0 & \frac{f_y}{Z'} & -\frac{f_yY'}{Z'^2} 
\end{bmatrix}\pmb{R}$$

于是，我们推导了观测相机方程关于相机位姿与特征点的两个导数矩阵。它们十分重要，能够在优化过程中提供重要的梯度方向，指导优化的迭代。

