&emsp;
# 1 状态估计问题
## 1.1 最大后验与最大似然
接着前面几章的内容，我们回顾一下第二讲讨论的经典 SLAM 模型。它由一个 `状态方程` 和一个 `运动方程` 构成，如式（2.5）所示：

$$\begin{cases}\pmb{x}_k = f(\pmb{x}_{k-1}, \pmb{u}_k, \pmb{w}_k) & 运动方程\\
\pmb{z}_{k,j} = h(\pmb{y}_j, \pmb{x}_k, \pmb{v}_{k,j}) & 观测方程\end{cases} $$

- 运动方程
    - $\pmb{x}_k$：相机 $k$ 时刻的位姿
    - $\pmb{x}_{k-1}$：相机 $k-1$ 时刻的位姿
    - $\pmb{u}_k$：是运动传感器的读数（有时也叫输入）
    - $\pmb{w}_k$：噪声
- 观测方程
    - $\pmb{z}_{k,j}$：观测数据
    - $\pmb{y}_j$：路标点
    - $\pmb{x}_k$：位置
    - $\pmb{v}_{k,j}$ 是这次观测里的噪声


通过第四讲的知识，我们了解到这里的 $\pmb{x}_k$ 是相机的位姿。我们可以使用`变换矩阵`或`李代数`表示它。

至于 `观测方程`，第五讲已经说明了它的内容，即 `针孔相机模型`。

&emsp;
>位姿变量 $\pmb{x}_k$ 的数学表示
- 为了让读者对它们有更深的印象，我们不妨讨论一下它们的具体参数化形式。首先，位姿变量 $\pmb{x}_k$ 可以由以下两种方式表达：

    - 变换矩阵：$\pmb{T}_k$ 

    - 李代数 $\mathfrak{se}(3)  \stackrel{指数映射}{\longrightarrow} SE(3)$：$exp(ξ^∧_k)$ 

    二者是等价的。由于运动方程在视觉 SLAM 中没有特殊性，我们暂且不讨论它，主要讨论观测方程。


&emsp;
>观测方程的数学表示
- 假设在 $\pmb{x}_k$ 处对路标 $\pmb{y}_j$ 进行了一次观测，对应到图像上的像素位置 $\pmb{z}_{k,j}$，那么，根据相机模型中的式 $（5.8）$
    $$Z\pmb{P}_{uv} = Z\begin{bmatrix}u \\ v \\ 1\end{bmatrix} = \pmb{K}(\pmb{R}\pmb{P}_w + \pmb{t}) = \pmb{KT}\pmb{P}_{w}\quad (5.8)$$
    - $\pmb{T}$：先坐标系转换
    - $\pmb{K}$：再投影到相机平面

    `观测方程` 可以表示成：

    $$sz_{k，j} = \pmb{K}exp(\xi^{\wedge})\pmb{y}_i$$

    - $K$ 为相机内参
    - $s$ 为像素点的距离
    - $z_{k,j}$ 和 $y_j$ 都必须以齐次坐标来描述，且中间有一次齐次到非齐次的转换

&emsp;
>机器人状态估计的本质
- 现在，考虑数据受噪声的影响后，会发生什么改变。在运动和观测方程中，我们通常假设两个噪声项 $\pmb{w}_k， \pmb{v}_{k,j}$ 满足零均值的高斯分布：

    $$\pmb{w}_{k} \sim N(0，\pmb{R}_k)，\pmb{v}_k \sim N(0，\pmb{Q}_{k，j})$$

    在这些噪声的影响下，我们希望通过带噪声的数据 $\pmb{z}$ 和 $\pmb{u}$，推断位姿 $\pmb{x}$ 和地图 $\pmb{y}$（以及它们的概率分布），这构成了一个状态估计问题。

    由于在 SLAM 过程中，这些数据是随着时间逐渐到来的，所以在历史上很长一段时间内，研究者们使用滤波器，尤其是`扩展卡尔曼滤波器（EKF）`求解它。

    卡尔曼滤波器关心当前时刻的状态估计 $\pmb{x}_k$，而对之前的状态则不多考虑；相对的，近年来普遍使用的非线性优化方法，使用所有时刻采集到的数据进行状态估计，并被认为优于传统的滤波器，成为当前视觉 SLAM 的主流方法。

    因此，本书重点介绍以非线性优化为主的优化方法，对卡尔曼滤波器则留到第十讲再进行讨论。本讲将介绍非线性优化的基本知识，然后在第十、十一讲中对它们进行更深入的分析。

    首先，我们从概率学角度来看一下我们正在讨论什么问题。在非线性优化中，我们把所有待估计的变量放在一个“状态变量”中：

    $$\pmb{x} = \{\pmb{x}_1，...，\pmb{x}_N，\pmb{y}_1，...，\pmb{y}_M\}$$
    - 所有时刻的 `位姿` 和 `路标`

    &emsp;

    现在，我们说，对机器人状态的估计，就是求已传感器知输入数据 $\pmb{u}$ 和观测数据 $\pmb{z}$ 的条件下，计算状态 $\pmb{x}$ 的条件概率分布：

    $$P(\pmb{x} | z, \pmb{u})$$

    类似于 $\pmb{x}$，这里 $\pmb{u}$ 和 $\pmb{z}$ 也是对所有数据的统称。

&emsp;
>贝叶斯法则
- 当我们只考虑观测方程，只有一张张的图像时，就是估计 $P(\pmb{x}|\pmb{z})$ 的条件概率分布。
    
    如果忽略图像在时间上的联系，把它们看作一堆彼此没有关系的图片，该问题也称为 `Structure from Motion（SfM）`，即如何从许多图像中重建三维空间结构 。

    在这种情况下，SLAM 可以看作是图像具有时间先后顺序的，需要实时求解一个 SfM 问题。为了估计状态变量的条件分布，利用贝叶斯法则，有：

    $$P(\pmb{x} | z) = \frac{P(z | \pmb{x})P(\pmb{x})}{P(z)} \propto P(z | \pmb{x})P(\pmb{x})$$

    - $P(\pmb{x} | z)$：`后验概率`
    - $P(z|\pmb{x})$：`似然`
    - $P(\pmb{x})$：`先验`
    - $\propto$：正比于

&emsp;
>后验概率最大化（Maximize a Posterior，MAP）
- 直接求后验分布是困难的，但是求一个状态最优估计，使得在该状态下，`后验概率最大化（Maximize a Posterior，MAP）`，则是可行的：

    $$\pmb{x}*_{MAP} = argmax\ P(\pmb{x} | z) = argmax\ P(z | \pmb{x})P(\pmb{x})$$

&emsp;
>最大似然估计（Maximize Likelihood Estimation, MLE）
- 请注意贝叶斯法则的分母部分与待估计的状态 $\pmb{x}$ 无关，因而可以忽略。
    
    贝叶斯法则告诉我们，求解最大后验概率，相当于最大化似然和先验的乘积。

    进一步，我们当然也可以说，对不起，我不知道机器人位姿、轨迹，此时就没有了先验。那么，可以求解 $x$ 的 `最大似然估计（Maximize Likelihood Estimation, MLE）`：

    $$\pmb{x}*_{MLE} = argmax\ P(z | \pmb{x})$$

    直观地说，似然是指 `在现在的位姿下，可能产生怎样的观测数据`。由于我们知道观测数据，所以最大似然估计，可以理解成：“在什么样的状态下，最可能产生现在观测到的数据”。这就是最大似然估计的直观意义。

    很重要，我们后面将根据这个思想求解 
    $$min(可能产生的观测数据 - 实际观测数据)^2$$