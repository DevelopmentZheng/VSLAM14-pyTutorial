
&emsp;
## 8.5.5 直接法的讨论

相比于特征点法，直接法完全依靠优化来求解相机位姿。从式（8.16）中可以看到，像素梯度引导着优化的方向。如果我们想要得到正确的优化结果，就必须保证大部分像素梯度能够把优化引导到正确的方向。

这是什么意思呢？我们不妨设身处地地扮演一下优化算法。假设对于参考图像，我们测量到一个灰度值为 $229$ 的像素。并且，由于我们知道它的深度，可以推断出空间点 $P$ 的位置（图 8-6 中在 $I_1$ 中测量到的灰度）。
<div align="center">
    <image src="./imgs/8.5-3.png" width = 800>
</div>
&emsp;

此时我们又得到了一张新的图像，需要估计它的相机位姿。这个位姿是由一个初值不断地优化迭代得到的。假设我们的初值比较差，在这个初值下，空间点 $P$ 投影后的像素灰度值是 $126$。于是，这个像素的误差为 $229 - 126 = 103$。为了减小这个误差，我们希望微调相机的位姿，使像素更亮一些。

怎么知道往哪里微调，像素会更亮呢？这就需要用到局部的像素梯度。我们在图像中发现
- 沿 $u$ 轴往前走一步，该处的灰度值变成了 $123$，即减去了 $3$
- 同样地，沿 $v$ 轴往前走一步，灰度值减 $18$，变成 $108$。在这个像素周围，我们看到梯度是 $[ 3, - 18]$

为了提高亮度，我们会建议优化算法微调相机，使 $P$ 的像往 `左上方` 移动。在这个过程中，我们用像素的局部梯度近似了它附近的灰度分布，不过请注意真实图像并不是光滑的，所以这个梯度在远处就不成立了。

但是，优化算法不能只听这个像素的一面之词，还需要听取其他像素的建议。综合听取了 `许多像素` 的意见之后，优化算法选择了一个 `和我们建议的方向偏离不远的` 地方，计算出一个更新量 $exp(ξ^∧)$（一个新的相机位姿）。加上更新量后，图像从 $I2$ 移动到了 $I'2$，像素的 `投影位置` 也变到了一个更亮的地方。我们看到，通过这次更新，误差变小了。

在理想情况下，我们期望误差会不断下降，最后收敛。

但是实际是不是这样呢？我们是否真的只要沿着梯度方向走，就能走到一个最优值？注意到，直接法的梯度是直接由图像梯度确定的，因此我们必须保证沿着图像梯度走时，灰度误差会不断下降。然而，图像通常是一个很强烈的非凸函数，如图 8-7 所示。

<div align="center">
    <image src="./imgs/8.5-4.png" width = 800>
</div>
&emsp;

实际当中，如果我们沿着图像梯度前进，很容易由于图像本身的非凸性（或噪声）落进一个局部极小值中，无法继续优化。只有当相机运动很小，图像中的梯度不会有很强的非凸性时，直接法才能成立。

在例程中，我们只计算了单个像素的差异，并且这个差异是由灰度直接相减得到的。然而，单个像素没有什么区分性，周围很可能有好多像素和它的亮度差不多。所以，我们有时会使用小的`图像块（patch）`，并且使用更复杂的差异度量方式，例如`归一化相关性（Normalized Cross Correlation，NCC）`等（见 13 讲）。而例程为了简单起见，使用了误差的平方和，以保持和推导的一致性。

&emsp;
## 8.5.6 直接法优缺点总结
>直接法的优点
- 可以省去计算特征点、描述子的时间。
- 只要求有像素梯度即可，无须特征点。因此，直接法可以在特征缺失的场合下使用。比较极端的例子是只有渐变的一张图像。它可能无法提取角点类特征，但可以用直接法估计它的运动。
- 可以构建半稠密乃至稠密的地图，这是特征点法无法做到的。

&emsp;
>直接法的缺点
- `非凸性`。直接法完全依靠梯度搜索，降低目标函数来计算相机位姿。其目标函数中需要取像素点的灰度值，而图像是强烈非凸的函数。这使得优化算法容易进入极小，只在运动很小时直接法才能成功。

- `单个像素没有区分度`。找一个和他像的实在太多了！——于是我们要么计算图像块，要么计算复杂的相关性。由于每个像素对改变相机运动的“意见”不一致。只能少数服从多数，以数量代替质量。

- `灰度值不变是很强的假设`。如果相机是自动曝光的，当它调整曝光参数时，会使得图像整体变亮或变暗。光照变化时亦会出现这种情况。特征点法对光照具有一定的容忍性，而直接法由于计算灰度间的差异，整体灰度变化会破坏灰度不变假设，使算法失败。针对这一点，目前的直接法开始使用更细致的 `光度模型标定相机`，以便在曝光时间变化时也能让直接法工作。