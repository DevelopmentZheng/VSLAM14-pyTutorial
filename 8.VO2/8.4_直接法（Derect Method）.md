&emsp;
# 8.4 直接法

接下来，我们来讨论与光流有一定相似性的直接法。与前面章节相似，我们先介绍直接法的原理，然后使用 $g2o$ 实现直接法。

&emsp;
## 8.4.1 直接法的推导
如图8-3所示，考虑某个空间点 $P$ 和两个时刻的相机。$P$ 的世界坐标为 $[X, Y, Z]$，它在两个相机上成像，记非齐次像素坐标为 $\pmb{p}_1， \pmb{p}_2$。我们的目标是求第一个相机到第二个相机的相对位姿变换。我们以第一个相机为参照系，设第二个相机旋转和平移为 $\pmb{R}， \pmb{t}$（对应李代数为 $ξ$）。同时，两相机的内参相同，记为 $\pmb{K}$。为清楚起见，我们列写完整的投影方程：

$\pmb{p}_1 = \begin{bmatrix}u \\ v \\ 1\end{bmatrix}_1 = 
\frac{1}{Z_1}\pmb{KP}$

$\pmb{p}_2 = \begin{bmatrix}u \\ v \\ 1\end{bmatrix}_2 = 
\frac{1}{Z_2}\pmb{K}(\pmb{RP}+\pmb{t}) = 
\frac{1}{Z_2}\pmb{K}(exp(ξ^∧)\pmb{P})_{1:3}$


其中 $Z_1$ 是 $P$ 的深度，$Z_2$ 是 $P$ 在第二个相机坐标系下的深度，也就是 $\pmb{RP} + \pmb{t}$ 的第三个坐标值。由于 $exp(ξ^∧)$ 只能和齐次坐标相乘，所以我们乘完之后要取出前三个元素。这和上一讲以及相机模型部分的内容是一致的。

回忆特征点法中，由于我们通过匹配描述子，知道了 $\pmb{p}_1, \pmb{p}_2$ 的像素位置，所以可以计算重投影的位置。但在直接法中，由于没有特征匹配，我们无从知道哪一个 $\pmb{p}_2$ 与 $\pmb{p}_1$ 对应着同一个点。直接法的思路是根据当前相机的位姿估计值，来寻找 p2 的位置。但若相机位姿不够好，$\pmb{p}_2$ 的外观和 $\pmb{p}_1$ 会有明显差别。于是，为了减小这个差别，我们优化相机的位姿，来寻找与 $\pmb{p}_1$ 更相似的 $\pmb{p}_2$。这同样可以通过解一个优化问题，但此时最小化的不是重投影误差，而是`光度误差（Photometric Error）`，也就是 $\pmb{P}$ 的两个像的亮度误差：

$$e = \pmb{I}_1 (\pmb{p}_1) - \pmb{I}_2 (\pmb{p}_2) \quad (8.10)$$

注意这里 e 是一个标量，所以没有加粗。同样的，优化目标为该误差的二范数，暂时取不加权的形式，为：

$$\min_ξJ(ξ) = \sum\limits_{i=1}^Ne_i^Te_i，e_i = 
\pmb{I}_1(\pmb{p}_1,i) - \pmb{I}_2(\pmb{p}_2,i)$$

注意这里的优化变量是相机位姿 $ξ$。为了求解这个优化问题，我们关心误差 $e$ 是如何随着相机位姿 $ξ$ 变化的，需要分析它们的导数关系。因此，使用李代数上的扰动模型。我们给 $exp(ξ)$ 左乘一个小扰动 $exp(δξ)$，得：


$$e(ξ ⊕ δξ)   = \pmb{I}_1\Big(\frac{1}{Z_1}\pmb{KP}\Big) -
                \pmb{I}_2\Big(\frac{1}{Z_2}\pmb{K}(exp(δξ^∧)exp(ξ^∧)\pmb{P}\Big) $$
$$\qquad\qquad \approx \pmb{I}_1\Big(\frac{1}{Z_1}\pmb{KP}\Big) -
                \pmb{I}_2\Big(\frac{1}{Z_2}\pmb{K}(1+δξ^∧)exp(ξ^∧)\pmb{P}\Big) $$
$$\qquad\qquad\qquad\qquad\quad  = \pmb{I}_1\Big(\frac{1}{Z_1}\pmb{KP}\Big) -
                \pmb{I}_2\Big(\frac{1}{Z_2}\pmb{K}exp(ξ^∧)\pmb{P}+
                \frac{1}{Z_2}\pmb{K}δξ^∧exp(ξ^∧)\pmb{P} \Big)$$

类似于上一章，记
$$\qquad\ \ \pmb{q} = δ\pmb{ξ}^∧exp(\pmb{ξ}^∧)\pmb{P}$$
$$\pmb{u} = \frac{1}{Z_2}\pmb{KP}$$

这里的 $\pmb{q}$ 为 $\pmb{P}$ 在扰动之后，位于第二个相机坐标系下的坐标，而 $\pmb{u}$ 为它的像素坐标。

利用一阶泰勒展开，有：

$$e(ξ ⊕ δξ)   = \pmb{I}_1\Big(\frac{1}{Z_1}\pmb{KP}\Big) -
                \pmb{I}_2\Big(\frac{1}{Z_2}\pmb{K}exp(ξ^∧)\pmb{P} + \pmb{u}\Big)$$

$$\qquad\qquad\qquad\qquad\quad\ \ \approx 
\pmb{I}_1\Big(\frac{1}{Z_1}\pmb{KP}\Big) -
\pmb{I}_2\Big(\frac{1}{Z_2}\pmb{K}exp(ξ^∧)\pmb{P} \Big) -
\frac{∂\pmb{I}_2}{∂\pmb{u}}\frac{∂\pmb{u}}{∂\pmb{q}}\frac{∂\pmb{q}}{∂δξ}δξ$$

$$\qquad\qquad\qquad\qquad\quad\  = 
e(ξ) - \frac{∂\pmb{I}_2}{∂\pmb{u}}\frac{∂\pmb{u}}{∂\pmb{q}}\frac{∂\pmb{q}}{∂δξ}δξ$$

我们看到，一阶导数由于链式法则分成了三项，而这三项都是容易计算的：

<div align="center">
    <image src="./imgs/8.4-1.png" width = 800>
</div>
&emsp;

## 8.4.2 直接法讨论

在我们上面的推导中，$P$ 是一个已知位置的空间点，它是怎么来的呢？在 $RGB-D$ 相机下，我们可以把任意像素反投影到三维空间，然后投影到下一个图像中。如果在单目相机中，这件事情要更为困难，因为我们还需考虑由 $P$ 的深度带来的不确定性。详细的深度估计放到 13 讲中讨论。现在我们先来考虑简单的情况，即 $P$ 深度已知的情况。

根据 $P$ 的来源，我们可以把直接法进行分类：
1. $P$ 来自于 `稀疏关键点`，我们称之为 `稀疏直接法`。通常我们使用数百个至上千个关键点，并且像 $L-K$ 光流那样，假设它周围像素也是不变的。这种稀疏直接法不必计算描述子，并且只使用数百个像素，因此速度最快，但只能计算稀疏的重构。

2. $P$ 来自 `部分像素`。我们看到式（8.16）中，如果像素梯度为零，整一项雅可比就为零，不会对计算运动增量有任何贡献。因此，可以考虑只使用带有梯度的像素点，舍弃像素梯度不明显的地方。这称之为 `半稠密（Semi-Dense）直接法`，可以重构一个半稠密结构。

3. $P$ 为 `所有像素`，称为 `稠密直接法`。稠密重构需要计算所有像素（一般几十万至几百万个），因此多数不能在现有的 CPU 上实时计算，需要 GPU 的加速。但是，如前面所讨论的，梯度不明显的点，在运动估计中不会有太大贡献，在重构时也会难以估计
位置。

可以看到，从稀疏到稠密重构，都可以用直接法来计算。它们的计算量是逐渐增长的。稀疏方法可以快速地求解相机位姿，而稠密方法可以建立完整地图。具体使用哪种方法，需要视机器人的应用环境而定。特别地，在低端的计算平台上，稀疏直接法可以做到非常快速的效果，适用于实时性较高且计算资源有限的场合