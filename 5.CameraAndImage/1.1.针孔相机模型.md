&emsp;
# 1 相机模型

相机将三维世界中的坐标点（单位为米）映射到二维图像平面（单位为像素）的过程能够用一个几何模型进行描述。

这个模型有很多种，其中最简单的称为`针孔模型`。针孔模型是很常用，而且有效的模型，它描述了一束光线通过针孔之后，在针孔背面投影成像的关系。在本书中我们用一个简单的针孔相机模型来对这种映射关系进行`建模`。同时，由于相机镜头上的透镜的存在，会使得光线投影到成像平面的过程中会产生畸变。因此，我们使用针孔和畸变两个模型来描述整个投影过程。

在本节我们先给出相机的针孔模型，再对透镜的畸变模型进行讲解。这两个模型能够把外部的三维点投影到相机内部成像平面，构成了相机的内参数。

&emsp;
# 1.1 针孔相机模型
在初中物理课堂上，我们可能都见过一个蜡烛投影实验：在一个暗箱的前方放着一支点燃的蜡烛，蜡烛的光透过暗箱上的一个小孔投影在暗箱的后方平面上，并在这个平面上形成了一个倒立的蜡烛图像。在这个过程中，小孔模型能够把三维世界中的蜡烛投影到一个二维成像平面。同理，我们可以用这个简单的模型来解释相机的成像过程。如图 5-1 所示。

<div align="center">
    <image src="./imgs/5.1-1.png" width = 600>
</div>
&emsp;
<div align="center">
    <image src="./imgs/5.1-3.png" width = 600>
</div>
&emsp;

&emsp;
## 1 针孔相机模型建模
现在来对这个简单的针孔模型进行几何建模。设：
- $O-x - y -z$ 为相机坐标系

- 让 $z$ 轴指向相机前方，$x$ 向右，$y$ 向下
- $O$ 为摄像机的光心，也是针孔模型中的针孔
- 现实世界的空间点 $P$，经过小孔 $O$ 投影之后，落在物理成像平面 $O'-x' - y' -z'$ 上，像点为 $P′$
- $P$ 的坐标为 $[X, Y, Z]^T$
- $P′$ 为 $[X′, Y ′, Z′]^T$
- 并且设物理成像平面到小孔的距离为 $f$（焦距）。


那么，根据三角形相似关系，有：
$$\frac{Z}{f} = -\frac{X}{X'} = -\frac{Y}{Y'} $$

其中负号表示成的像是倒立的。为了简化模型，我们把可以成像平面对称到相机前方，和三维空间点一起放在摄像机坐标系的同一侧，如图 5-2 中间的样子所示。这样做可以把公式中的负号去掉，使式子更加简洁：

$$\frac{Z}{f} = \frac{X}{X'} = \frac{Y}{Y'} $$

<div align="center">
    <image src="./imgs/5.1-2.png" width = 600>
</div>
&emsp;

整理得：
$$\begin{cases}X' = f\frac{X}{Z}\\ 
\\
Y' = f\frac{Y}{Z} \end{cases} \quad (5.3)$$

为什么我们可以看似随意地把成像平面挪到前方呢？

这只是我们处理真实世界与相机投影的数学手段，并且，大多数相机输出的图像并不是倒像——相机自身的软件会帮你翻转这张图像，所以你看到的一般是正着的像，也就是对称的成像平面上的像。

所以，尽管从物理原理来说，小孔成像应该是倒像，但由于我们对图像作了预处理，所以理解成在对称平面上的像，并不会带来什么坏处。于是，在不引起歧义的情况下，我们也不加限制地称后一种情况为针孔模型。

&emsp;
## 2 从物体到像素
式（5.3）描述了点 P 和它的像之间的空间关系。不过，在相机中，我们最终获得的是一个个的像素，这需要在成像平面上对像进行采样和量化。

为了描述传感器将感受到的光线转换成图像像素的过程，我们设在物理成像平面上固定着一个像素平面 `o-u-v`。我们在像素平面得到了 $P'$ 的像素坐标：$[u, v]^T$。

像素坐标系通常的定义方式是：原点 $o′$ 位于图像的左上角，$u$ 轴向右与 $x$ 轴平行，$v$轴向下与 $y$ 轴平行。像素坐标系与成像平面之间，相差了
- 一个缩放
    - 设像素坐标在 $u$ 轴上缩放了 $α$ 倍

    - 在 $v$ 上缩放了 $β$ 倍

- 一个原点的平移：设原点平移了 $[c_x, c_y]^T$

那么，$P'$ 的坐标与像素坐标 $[u, v]^T$ 的关系为：

$$\begin{cases} u = \alpha X' + c_x \\
v = \beta Y' + c_y\end{cases}$$

将式 (5.3) 代入，并把 $\alpha f$ 合并成 $f_x$，把 $\beta f$ 合并成 $f_y$，得：

$$\begin{cases} u = f_x \frac{X}{Z} + c_x \\
v = f_y \frac{Y}{Z}  + c_y\end{cases}$$

- $f$ 的单位：m（米）

- $α， β$ 的单位：pix/m（像素每米）
- $fx, fy$ 的单位：pix（像素）

&emsp;
>相机坐标 -> 像素坐标
$$\begin{cases} u = f_x \frac{X}{Z} + c_x \\
v = f_y \frac{Y}{Z}  + c_y\end{cases}$$
- $X，Y，Z$：相机坐标的 $X，Y，Z$（深度 depth）
- $f_x，f_y$：缩放系数
- $c_x，c_y$：中心偏移量
- $u，v$：像素坐标

&emsp;
>像素坐标 -> 相机坐标
- 需要知道深度 $Z$（depth）
- 再根据上述式子，求 $X，Y$

$$\begin{cases} X = (u - c_x)/f_x \times Z  \\
Y = (v - c_y)/f_y \times Z \end{cases}$$

&emsp;
## 3 内参数矩阵（Camera Intrinsics）$\pmb{K}$
- 即投影成像的过程

把该式写成矩阵形式，会更加简洁，不过左侧需要用到齐次坐标：
$$\begin{pmatrix}u \\ v \\ 1\end{pmatrix} = 
\frac{1}{Z}
\begin{pmatrix}f_x & 0 & c_x \\
0 & f_y & c_y \\
0 & 0 & 1\end{pmatrix}
\begin{pmatrix} X \\ Y \\ Z\end{pmatrix}
\triangleq \frac{1}{Z}\pmb{KP}\quad (5.6)$$

我们按照传统的习惯，把 $Z$ 挪到左侧：

$$Z\begin{pmatrix}u \\ v \\ 1\end{pmatrix} = 
\begin{pmatrix}f_x & 0 & c_x \\
0 & f_y & c_y \\
0 & 0 & 1\end{pmatrix}
\begin{pmatrix} X \\ Y \\ Z\end{pmatrix}
\triangleq \pmb{KP}\quad (5.7)$$

该式中，我们把中间的量组成的矩阵称为相机的 `内参数矩阵（Camera Intrinsics）`$\pmb{K}$。

&emsp;
## 4 相机标定
通常认为，相机的内参在出厂之后是固定的，不会在使用过程中发生变化。有的相机生产厂商会告诉你相机的内参，而有时需要你自己确定相机的内参，也就是所谓的标定。

鉴于标定算法业已成熟，且网络上能找到大量的标定教学，我们在此就不介绍了。

&emsp;
## 5 相机的外参数（Camera Extrinsics）$\pmb{T}_{cw}$
- 即坐标系的转换

除了内参之外，自然还有相对的外参。考虑到在式 $(5.7)$ 中 $X，Y，Z$ 使用的是 $P$ 在相机坐标系下的坐标。由于相机在运动，所以 $P$ 的相机坐标应该是它的 `世界坐标`（记为 $\pmb{P}_w$）

$$Z \begin{pmatrix}u \\ v \\ 1\end{pmatrix} = 
\begin{pmatrix}f_x & 0 & c_x \\
0 & f_y & c_y \\
0 & 0 & 1\end{pmatrix}
\begin{pmatrix} \pmb{X}_w \\ \pmb{Y}_w \\ \pmb{Z}_w\end{pmatrix}
\triangleq \pmb{K}\pmb{P}_w\quad (5.7)$$

根据相机的当前位姿，变换到相机坐标系下的结果。相机的位姿由它的旋转矩阵 $\pmb{R}$ 和平移向量 $\pmb{t}$ 来描述。那么有：

$$(\pmb{R}\pmb{P}_w + \pmb{t})  =\pmb{T}\pmb{P}_{w}$$

结合式 $(5.7)$ 有：
$$Z\pmb{P}_{uv} = Z\begin{bmatrix}u \\ v \\ 1\end{bmatrix} = 
\pmb{K}(\pmb{R}\pmb{P}_w + \pmb{t}) = 
\pmb{KT}_{cw}\pmb{P}_{w}\quad (5.8)$$

注意后一个式子隐含了一次齐次坐标到非齐次坐标的转换（你能看出来吗？）。它描述了 $P$ 的世界坐标到像素坐标的投影关系。其中，相机的位姿 $\pmb{R}， \pmb{t}$ 又称为相机的 `外参数（Camera Extrinsics）`。

相比于不变的内参，外参会随着相机运动发生改变，同时也是 SLAM 中待估计的目标，代表着机器人的轨迹。

&emsp;
>世界坐标 -> 像素坐标
- 世界坐标 -> 相机坐标 -> 像素坐标（归一化/齐次坐标）
$$\pmb{P}_{c} = 
 \pmb{K}\pmb{T}_{cw}\pmb{P}_w /Z
\Rightarrow 
\begin{bmatrix}u \\ v \\ 1\end{bmatrix} = 
\begin{bmatrix}
f_x & 0 & c_x \\
0 & f_y & c_y \\
0 & 0   & 1
\end{bmatrix}
\pmb{T}_{cw}
\begin{bmatrix} \pmb{X}_w \\ \pmb{Y}_w \\ \pmb{Z}_w\end{bmatrix}/Z$$

&emsp;
>像素坐标 -> 世界坐标
- 像素坐标（归一化/齐次坐标） -> 相机坐标 -> 世界坐标

    >像素坐标 -> 相机坐标
    - 需要知道深度 $Z$（depth）
    - 再根据上述式子，求 $X，Y$

    $$\begin{cases} X = (u - c_x)/f_x \times Z  \\
    Y = (v - c_y)/f_y \times Z \end{cases}$$


&emsp;
## 6 归一化处理
&emsp;
>齐次坐标（复习）
- 齐次坐标：https://www.bilibili.com/video/BV1LS4y1b7xZ?spm_id_from=333.337.search-card.all.click&vd_source=ead820d10887c21595d014f264bcbb35

    稍微来说一下齐次坐标。它是射影几何里的概念。通过添加最后一维，我们用四个实数描述了一个三维向量，这显然多了一个自由度，但允许我们把变换写成线性的形式。在齐次坐标中，某个点 $x$ 的每个分量同乘一个非零常数 $k$ 后，仍然表示的是同一个点。因此，一个点的具体坐标值不是唯一的。如 $[1, 1, 1, 1]^T$ 和 $[2, 2, 2, 2]^T$ 是同一个点。但当最后一项不为零时，我们总可以把所有坐标除以最后一项，强制最后一项为 $1$，从而得到一个点唯一的坐标表示（也就是转换成非齐次坐标）：

    $$\tilde{x} = [x, y, z, w]^T = [x/w, y/w, z/w, 1]^T$$
    这时，忽略掉最后一项，这个点的坐标和欧氏空间就是一样的。依靠齐次坐标和变换矩阵，两次变换的累加就可以有很好的形式：
    $$\tilde{b} = \pmb{T}_1\tilde{a}， \tilde{c} = \pmb{T}_2\tilde{b} \quad \Rightarrow \quad \tilde{c} = \pmb{T}_2\pmb{T}_1 \tilde{a}$$

    但是区分齐次和非齐次坐标的符号令我们厌烦。在不引起歧义的情况下，以后我们就直接把它写成 $\pmb{b} = \pmb{T} \pmb{a}$ 的样子，默认其中是齐次坐标了。

&emsp;

回忆一下第三章的式 $(3.9)$
$$\begin{bmatrix} \pmb{a'} \\ \\ 1\end{bmatrix} = 
\begin{bmatrix} \pmb{R} & \pmb{t} \\ \\ 
0^T & 1\end{bmatrix} \begin{bmatrix} \pmb{a} \\ \\ 1\end{bmatrix}\triangleq
\pmb{T}_{cw}\begin{bmatrix} \pmb{a} \\\\ 1\end{bmatrix} \quad (3.9)$$

式 $(5.8)$ 两侧都是齐次坐标。因为齐次坐标乘上 `非零常数` 后表达同样的含义，所以可以简单地把常数 $Z$ 去掉：

$$Z\pmb{P}_{uv} = Z\begin{bmatrix}u \\ v \\ 1\end{bmatrix} = 
\pmb{K}(\pmb{R}\pmb{P}_w + \pmb{t}) = 
\pmb{KT}_{cw}\pmb{P}_{w}\quad (5.8)$$
$$\Downarrow$$
$$\pmb{P}_{uv} = \pmb{KT}_{cw}\pmb{P}_w$$

但这样等号意义就变了，成为在齐次坐标下相等的概念，相差了一个非零常数。为了避免麻烦，我们还是从传统意义下来定义书写等号。

我们还是提一下隐含着的齐次到非齐次的变换吧。可以看到，右侧的 $\pmb{T}_{cw}\pmb{P}_w$ 表示把一个世界坐标系下的齐次坐标，变换到相机坐标系下。

为了使它与 $\pmb{K}$ 相乘，需要取它的前三维组成向量——因为 $\pmb{T}_{cw}\pmb{P}_w$ 最后一维为 $1$。此时，对于这个三维向量，我们还可以按照齐次坐标的方式，把最后一维进行归一化处理，得到了 $P$ 在相机归一化平面上的投影 $\tilde{P}$：

$$\pmb{\tilde{P}}_c = \begin{bmatrix}
X \\ Y \\ Z\end{bmatrix} = (\pmb{T}_{cw}\pmb{P}_w)_{1:3} ，
\pmb{P}_c = \begin{bmatrix}
X/Z \\ Y/Z \\ 1\end{bmatrix}$$

因为相机平面投影只有二维，所以，这时 $\pmb{P}_c$ 可以看成一个 `二维` 的齐次坐标，称为 `归一化坐标`。它位于相机前方 $z = 1$ 处的平面上。该平面称为 `归一化平面`。由于 $\pmb{P}_c$ 经过内参之后就得到了像素坐标，所以我们可以把像素坐标 $[u, v]^T$，看成对归一化平面上的点进行量化测量的结果。